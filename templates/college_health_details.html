<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ college_health.college.user.username }} - Health Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.css" />
    <style>
        body {
            background-color: #1e1e1e;
            font-family: Arial, sans-serif;
            color: #ccc;
            margin: 0;
            padding: 0;
        }

        .container {
            margin: 20px auto; /* Center the container */
            max-width: 1200px; /* Set a max width */
        }

        .card {
            background: linear-gradient(45deg, #f7f7f7, #e0e0e0);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: black;
            width: 100%;
            margin-bottom: 20px;
            text-align: center; /* Centering the text in the card */
        }

        .feedback-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 0; /* Reset margin for consistent layout */
        }

        .feedback-section {
            background-color: #2b2b2b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            width: 45%; /* Width for the feedback section */
            display: flex;
            flex-direction: column; /* Align items vertically */
            justify-content: space-between; /* Evenly space items */
            margin-right: 10px; /* Space between feedback and chart */
        }

        .chart-container {
            width: 45%; /* Width for the chart container */
            padding: 20px;
            background-color: #ffffff; /* White background for the chart container */
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .feedback-buttons {
            display: flex;
            justify-content: space-between;
            max-width: 300px;
            margin: 0 auto;
        }

        button {
            width: 120px;
            padding: 10px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
        }

        #agree-btn {
            background-color: #b8e1d9; /* Lighter green */
            color: black;
        }

        #disagree-btn {
            background-color: #ffcccc; /* Lighter red */
            color: black;
        }

        #feedback-message {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #f8c291;
        }

        canvas {
            background-color: #ffffff; /* White background for the chart */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Shadow effect */
        }

        /* Formatting styles for the detailed breakdown */
        .breakdown {
            text-align: left; /* Left-align the breakdown text */
            margin-top: 20px; /* Add space above the breakdown */
            line-height: 1.6; /* Increase line height for better readability */
        }

        .breakdown p {
            margin: 5px 0; /* Add margin for individual paragraphs */
        }

        @media (max-width: 600px) {
            .feedback-container {
                flex-direction: column; /* Stack feedback and chart on mobile */
                align-items: center; /* Center items */
            }

            .feedback-section,
            .chart-container {
                width: 90%; /* Wider sections on mobile */
                margin-bottom: 20px; /* Add space between stacked items */
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="container">
        <div class="card">
            <h2>{{ college_health.college.user.username }}</h2>
            <p><strong>Health Score (Gemini):</strong>{{ gemini_health_score|striptags }}</p>

            <h3>Gemini's Detailed Breakdown:</h3>
            <div class="breakdown">
                <p><strong>Academic Performance:</strong> - NIRF Ranking: 1 - NAAC Accreditation: Grade A++</p>
                <p><strong>Student Satisfaction:</strong> - High student satisfaction rates in surveys - Vibrant campus life with numerous clubs and organizations</p>
                <p><strong>Placement Opportunities:</strong> - Excellent placement record - Strong relationships with top recruiters - High salary packages offered to graduates</p>
            </div>
        </div>

        <div class="feedback-container">
            <div class="feedback-section">
                <h3>Student Feedback:</h3>
                <p><strong>Agreements:</strong> <span id="agreement-count">{{ college_health.number_of_agreements }}</span> (<span id="agreement-percentage">{{ agreement_percentage }}%</span>)</p>
                <p><strong>Disagreements:</strong> <span id="disagreement-count">{{ college_health.number_of_disagreements }}</span> (<span id="disagreement-percentage">{{ disagreement_percentage }}%</span>)</p>

                <div class="feedback-buttons">
                    <button type="button" id="agree-btn" name="feedback_type" value="Agree">✔️ Agree</button>
                    <button type="button" id="disagree-btn" name="feedback_type" value="Disagree">❌ Disagree</button>
                </div>

                <p id="feedback-message"></p>
            </div>

            <div class="chart-container">
                <canvas id="feedback-chart" width="400" height="300"></canvas>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('feedback-chart').getContext('2d');
        let feedbackChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Agreements', 'Disagreements'],
                datasets: [{
                    label: 'Student Feedback',
                    data: [{{ college_health.number_of_agreements }}, {{ college_health.number_of_disagreements }}],
                    backgroundColor: ['#b8e1d9', '#ffcccc'], // Lighter colors
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Maintain aspect ratio for responsive design
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#333'
                        }
                    }
                }
            }
        });

        $(document).ready(function() {
            $('#agree-btn, #disagree-btn').click(function(e) {
                e.preventDefault();
                var feedback_type = $(this).val();
                var college_id = "{{ college_health.college.id }}";
                var csrf_token = '{{ csrf_token }}';

                $('#agree-btn, #disagree-btn').prop('disabled', true);

                $.ajax({
                    url: "{% url 'submit_feedback' college_health.college.id %}",
                    type: 'POST',
                    data: {
                        'feedback_type': feedback_type,
                        'csrfmiddlewaretoken': csrf_token
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#feedback-message').text('Thank you for your feedback!');
                            $('#agreement-count').text(response.agreement_count);
                            $('#disagreement-count').text(response.disagreement_count);
                            $('#agreement-percentage').text(response.agreement_percentage + '%');
                            $('#disagreement-percentage').text(response.disagreement_percentage + '%');

                            // Update the chart dynamically
                            feedbackChart.data.datasets[0].data = [response.agreement_count, response.disagreement_count];
                            feedbackChart.update();
                        } else if (response.status === 'already_submitted') {
                            $('#feedback-message').text('You have already submitted feedback for this college.');
                        }
                    },
                    error: function() {
                        $('#feedback-message').text('An error occurred. Please try again.');
                    },
                    complete: function() {
                        $('#agree-btn, #disagree-btn').prop('disabled', false);
                    }
                });
            });
        });
    </script>

</body>

</html>
