<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>{{ college_health.college.user.username }} - Health Details</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.css" />
    <style>
        body {
            background-color: #1e1e1e;
            font-family: Arial, sans-serif;
            color: #ccc;
            margin: 0;
            padding: 0;
        }

        .container {
            margin: 20px auto;
            max-width: 1200px;
        }

        /* New flex container for card and feedback */
        .flex-container {
            display: flex;
            flex-direction: column; /* Stack vertically by default */
            gap: 20px;
        }

        .card, .feedback-container {
            width: 100%; /* Ensure they share the same width */
        }

        .card {
            background: linear-gradient(45deg, #FFFDD0, #e0e0e0);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: black;
            margin-bottom: 20px;
            text-align: center;
        }

        .feedback-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .feedback-section {
            background-color: #2b2b2b;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            color: white;
            width: 45%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .chart-container {
            width: 45%;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .feedback-buttons {
            display: flex;
            justify-content: space-between;
            max-width: 300px;
            margin: 0 auto;
        }

        button {
            width: 120px;
            padding: 10px;
            border-radius: 30px;
            border: none;
            cursor: pointer;
        }

        #agree-btn {
            background-color: #b8e1d9;
            color: black;
        }

        #disagree-btn {
            background-color: #ffcccc;
            color: black;
        }

        #feedback-message {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
            color: #f8c291;
        }

        canvas {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .breakdown {
            text-align: left;
            margin-top: 20px;
            line-height: 1.6;
        }

        .breakdown p {
            margin: 5px 0;
        }

        @media (max-width: 600px) {
            .feedback-container {
                flex-direction: column;
                align-items: center;
            }

            .feedback-section,
            .chart-container {
                width: 90%;
                margin-bottom: 20px;
            }
        }
    </style>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="container">
        <!-- New flex container -->
        <div class="flex-container">
            <div class="card">
                <h2>{{ college_health.college.user.username }}</h2>
                <p><strong>{{ gemini_health_score|striptags }}</strong></p>

                <h3>Gemini's Detailed Breakdown:</h3>
                <div class="breakdown">
                    {% if health_score_description %}
                        <p>{{ health_score_description|linebreaks }}</p>
                    {% else %}
                        <p>No detailed breakdown available at the moment.</p>
                    {% endif %}
                </div>
            </div>

            <div class="feedback-container">
                <div class="feedback-section">
                    <h3>Student Feedback:</h3>
                    <p><strong>Agreements:</strong> <span id="agreement-count">{{ college_health.number_of_agreements }}</span> (<span id="agreement-percentage">{{ agreement_percentage }}%</span>)</p>
                    <p><strong>Disagreements:</strong> <span id="disagreement-count">{{ college_health.number_of_disagreements }}</span> (<span id="disagreement-percentage">{{ disagreement_percentage }}%</span>)</p>

                    <div class="feedback-buttons">
                        <button type="button" id="agree-btn" name="feedback_type" value="Agree">✔️ Agree</button>
                        <button type="button" id="disagree-btn" name="feedback_type" value="Disagree">❌ Disagree</button>
                    </div>

                    <p id="feedback-message"></p>
                </div>

                <div class="chart-container">
                    <canvas id="feedback-chart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        const ctx = document.getElementById('feedback-chart').getContext('2d');
        let feedbackChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['Agreements', 'Disagreements'],
                datasets: [{
                    label: 'Student Feedback',
                    data: [{{ college_health.number_of_agreements }}, {{ college_health.number_of_disagreements }}],
                    backgroundColor: ['#b8e1d9', '#ffcccc'],
                    borderWidth: 1,
                    borderColor: '#ffffff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: '#333'
                        }
                    }
                }
            }
        });

        $(document).ready(function() {
            $('#agree-btn, #disagree-btn').click(function(e) {
                e.preventDefault();
                var feedback_type = $(this).val();
                var college_id = "{{ college_health.college.id }}";
                var csrf_token = '{{ csrf_token }}';

                $('#agree-btn, #disagree-btn').prop('disabled', true);

                $.ajax({
                    url: "{% url 'submit_feedback' college_health.college.id %}",
                    type: 'POST',
                    data: {
                        'feedback_type': feedback_type,
                        'csrfmiddlewaretoken': csrf_token
                    },
                    success: function(response) {
                        if (response.status === 'success') {
                            $('#feedback-message').text('Thank you for your feedback!');
                            $('#agreement-count').text(response.agreement_count);
                            $('#disagreement-count').text(response.disagreement_count);
                            $('#agreement-percentage').text(response.agreement_percentage + '%');
                            $('#disagreement-percentage').text(response.disagreement_percentage + '%');

                            feedbackChart.data.datasets[0].data = [response.agreement_count, response.disagreement_count];
                            feedbackChart.update();
                        } else if (response.status === 'already_submitted') {
                            $('#feedback-message').text('You have already submitted feedback for this college.');
                        }
                    },
                    error: function() {
                        $('#feedback-message').text('An error occurred. Please try again.');
                    },
                    complete: function() {
                        $('#agree-btn, #disagree-btn').prop('disabled', false);
                    }
                });
            });
        });
    </script>

</body>

</html>
